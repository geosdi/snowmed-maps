<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pietrattina Graph</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2e;
      --panel2:#0f172a;
      --text:#e8eefc;
      --muted:#a8b3d6;
      --line:#223152;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% 0%, #132044 0%, var(--bg) 50%) fixed;
      color:var(--text);
    }
    header{
      padding:24px 18px 12px;
      max-width: 1200px;
      margin:0 auto;
    }
    .title{
      display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;
    }
    h1{ margin:0; font-size:28px; letter-spacing:.2px; }
    .subtitle{
      font-size:14px; color:var(--muted);
      border-left: 2px solid var(--line);
      padding-left:12px;
    }
    .topbar{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .status{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      font-size:13px; color:var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--warn); box-shadow:0 0 0 3px rgba(251,191,36,.15); }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 3px rgba(52,211,153,.15); }
    .dot.bad{ background:var(--bad); box-shadow:0 0 0 3px rgba(251,113,133,.15); }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(125,211,252,.14); border-color: rgba(125,211,252,.35); }
    .btn.primary:hover{ background: rgba(125,211,252,.18); }
    .btn.ghost{ background: transparent; }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 14px 18px 26px;
    }

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 10px 0 16px;
    }
    .tab{
      padding:10px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      font-size:13px;
    }
    .tab.active{
      color: var(--text);
      background: rgba(167,139,250,.18);
      border-color: rgba(167,139,250,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 360px 1fr; align-items:start; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      font-size:14px;
      color: var(--muted);
      letter-spacing:.2px;
      padding:14px 14px 0;
    }
    .card .content{ padding: 12px 14px 14px; }

    .controls{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .row.two{
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    label{
      font-size:12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
    }
    input[type="number"], select{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    input[type="number"]::placeholder{ color: rgba(232,238,252,.35); }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.3;
    }
    .pill{
      font-size:12px;
      color: var(--muted);
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      padding:4px 8px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill b{ color: var(--text); font-weight:800; }
    .chartWrap{
      padding: 10px 12px 14px;
    }
    .chartTop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 14px 14px 0;
      flex-wrap:wrap;
    }
    .chartTitle{
      font-size:14px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .chartActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    canvas{
      width:100% !important;
      height: 520px !important;
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 14px;
    }
    .hidden{ display:none !important; }

    .checkgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      max-height: 240px;
      overflow:auto;
    }
    .chk{
      display:flex; gap:10px; align-items:center;
      font-size:13px; color: var(--text);
    }
    .chk input{ transform: translateY(1px); }
    .mono{ font-family: var(--mono); font-size:12px; color: var(--muted); }
    a{ color: var(--accent); }
  </style>
</head>

<body>
  <header>
    <div class="title">
      <h1>Pietrattina Graph</h1>
      <div class="subtitle">PRIN ROMA3</div>
    </div>

    <div class="topbar">
      <div class="status">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Loading data from GitHub…</span>
        <span class="pill" id="pillAsta" title="Rod heights"><b>Rod</b> <span id="pillAstaVal">—</span></span>
        <span class="pill" id="pillGpr" title="GPR"><b>GPR</b> <span id="pillGprVal">—</span></span>
        <span class="pill" id="pillVna" title="VNA"><b>VNA</b> <span id="pillVnaVal">—</span></span>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button class="btn primary" id="btnReload">Reload data</button>
        <button class="btn ghost" id="btnReset">Reset filters</button>
      </div>
    </div>
  </header>

  <main>
    <div class="tabs">
      <button class="tab active" data-tab="asta">Rod</button>
      <button class="tab" data-tab="gpr">GPR</button>
      <button class="tab" data-tab="vna">VNA</button>
    </div>

    <!-- ROD (ASTA) -->
    <section id="tab-asta" class="grid">
      <div class="card">
        <h2>Controls</h2>
        <div class="content">
          <div class="controls">
            <div class="row">
              <label>Line / Compare</label>
              <select id="astaLine">
                <option value="LINE11">LINE11</option>
                <option value="LINE12">LINE12</option>
                <option value="COMPARE">Compare LINE11 vs LINE12</option>
              </select>
            </div>

            <div class="row two">
              <div>
                <label>Min position (m)</label>
                <input type="number" id="astaMin" step="0.01" placeholder="auto" />
              </div>
              <div>
                <label>Max position (m)</label>
                <input type="number" id="astaMax" step="0.01" placeholder="auto" />
              </div>
            </div>

            <div class="row">
              <button class="btn primary" id="astaApply">Update chart</button>
            </div>

            <div class="hint" id="astaStats">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="chartTop">
          <div class="chartTitle">Rod heights</div>
          <div class="chartActions">
            <button class="btn" id="astaPng">Export PNG</button>
            <button class="btn" id="astaCsv">Export CSV</button>
          </div>
        </div>
        <div class="chartWrap">
          <canvas id="astaChart"></canvas>
        </div>
      </div>
    </section>

    <!-- GPR -->
    <section id="tab-gpr" class="grid hidden">
      <div class="card">
        <h2>Controls</h2>
        <div class="content">
          <div class="controls">
            <div class="row">
              <label>Line / Compare</label>
              <select id="gprLine">
                <option value="LINE11">LINE11</option>
                <option value="LINE12">LINE12</option>
                <option value="COMPARE">Compare LINE11 vs LINE12</option>
              </select>
            </div>

            <div class="row two">
              <div>
                <label>Min position (m)</label>
                <input type="number" id="gprMin" step="0.01" placeholder="auto" />
              </div>
              <div>
                <label>Max position (m)</label>
                <input type="number" id="gprMax" step="0.01" placeholder="auto" />
              </div>
            </div>

            <div class="row">
              <label>Series to show</label>
              <div class="checkgrid">
                <label class="chk"><span>Twtt (ns)</span><input type="checkbox" id="gprShowTwtt" checked /></label>
                <label class="chk"><span>Snow height (m)</span><input type="checkbox" id="gprShowSnow" checked /></label>
              </div>
            </div>

            <div class="row">
              <button class="btn primary" id="gprApply">Update chart</button>
            </div>

            <div class="hint" id="gprStats">—</div>
            <div class="mono">Note: decimation (LTTB) is enabled for large datasets to keep the chart responsive.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="chartTop">
          <div class="chartTitle">GPR</div>
          <div class="chartActions">
            <button class="btn" id="gprPng">Export PNG</button>
            <button class="btn" id="gprCsv">Export CSV</button>
          </div>
        </div>
        <div class="chartWrap">
          <canvas id="gprChart"></canvas>
        </div>
      </div>
    </section>

    <!-- VNA -->
    <section id="tab-vna" class="grid hidden">
      <div class="card">
        <h2>Controls</h2>
        <div class="content">
          <div class="controls">
            <div class="row">
              <label>Mode</label>
              <select id="vnaMode">
                <option value="SWEEP">Sweep (variable vs frequency)</option>
                <option value="PROFILE">Profile (variable vs H_cm)</option>
              </select>
            </div>

            <div class="row" id="vnaVarRow">
              <label>Variable (Y)</label>
              <select id="vnaVar"></select>
            </div>

            <div class="row" id="vnaSweepGroups">
              <label>Series (Measurement / H_cm)</label>
              <div class="checkgrid" id="vnaGroupList"></div>
            </div>

            <div class="row two" id="vnaFreqRange">
              <div>
                <label>Min f (GHz)</label>
                <input type="number" id="vnaFMin" step="0.01" placeholder="auto" />
              </div>
              <div>
                <label>Max f (GHz)</label>
                <input type="number" id="vnaFMax" step="0.01" placeholder="auto" />
              </div>
            </div>

            <div class="row two hidden" id="vnaHRange">
              <div>
                <label>Min H (cm)</label>
                <input type="number" id="vnaHMin" step="1" placeholder="auto" />
              </div>
              <div>
                <label>Max H (cm)</label>
                <input type="number" id="vnaHMax" step="1" placeholder="auto" />
              </div>
            </div>

            <div class="row hidden" id="vnaAggRow">
              <label>Profile aggregation</label>
              <select id="vnaAgg">
                <option value="MEAN">Mean</option>
                <option value="MEDIAN">Median</option>
              </select>
            </div>

            <div class="row">
              <button class="btn primary" id="vnaApply">Update chart</button>
            </div>

            <div class="hint" id="vnaStats">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="chartTop">
          <div class="chartTitle">VNA</div>
          <div class="chartActions">
            <button class="btn" id="vnaPng">Export PNG</button>
            <button class="btn" id="vnaCsv">Export CSV</button>
          </div>
        </div>
        <div class="chartWrap">
          <canvas id="vnaChart"></canvas>
        </div>
      </div>
    </section>
  </main>

<script>
/* =======================
   Config: CSV files on GitHub
   ======================= */
const URLS = {
  asta11: "https://raw.githubusercontent.com/geosdi/snowmed-maps/refs/heads/main/Altezze_asta_LINE11_22012025_Pietrattina.csv",
  asta12: "https://raw.githubusercontent.com/geosdi/snowmed-maps/refs/heads/main/Altezze_asta_LINE12_22012025_Pietrattina.csv",
  gpr11:  "https://raw.githubusercontent.com/geosdi/snowmed-maps/refs/heads/main/Dati_GPR_LINE11_22012025_Pietrattina.csv",
  gpr12:  "https://raw.githubusercontent.com/geosdi/snowmed-maps/refs/heads/main/Dati_GPR_LINE12_22012025_Pietrattina.csv",
  vna:    "https://raw.githubusercontent.com/geosdi/snowmed-maps/refs/heads/main/Dati_VNA_22012025_Pietrattina.csv",
};

const $ = (id) => document.getElementById(id);

const state = {
  loaded: false,
  raw: { asta11: [], asta12: [], gpr11: [], gpr12: [], vna: [] },
  charts: { asta: null, gpr: null, vna: null },
  vnaGroups: [], // {key,label, misura, h_cm}
};

/* =======================
   Utilities
   ======================= */
function setStatus(kind, text){
  const dot = $("statusDot");
  dot.classList.remove("ok","bad");
  if(kind === "ok") dot.classList.add("ok");
  if(kind === "bad") dot.classList.add("bad");
  $("statusText").textContent = text;
}

function safeNum(v){
  if(v === null || v === undefined) return null;
  if(typeof v === "number") return Number.isFinite(v) ? v : null;
  const s = String(v).trim().replace(",", ".");
  if(s === "" || s.toLowerCase() === "nan") return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function normalizeHeader(h){
  return String(h ?? "")
    .trim()
    .replace(/^["']|["']$/g, "")
    .replace(/\s+/g, " ");
}

// Map headers to canonical keys (to handle spaces/units in CSV)
function mapFieldKey(h){
  const t = normalizeHeader(h).toLowerCase();
  if(t.startsWith("position")) return "position_m";
  if(t.includes("twtt")) return "twtt_ns";
  if(t.includes("snow height")) return "snow_height_m";
  if(t.includes("height") && t.includes("(cm)") && !t.includes("snow")) return "height_cm";
  if(t === "f_hz" || t.includes("f_hz")) return "f_hz";
  if(t === "h_cm" || t.includes("h_cm")) return "h_cm";
  if(t === "date_num") return "date_num";
  if(t === "misura") return "misura";
  // Other VNA columns: eps_re, u_eps_re, eps_im, u_eps_im, lwc, density...
  return t
    .replace(/[()]/g,"")
    .replace(/[^\w]+/g,"_")
    .replace(/_+/g,"_")
    .replace(/^_+|_+$/g,"");
}

async function fetchText(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return await res.text();
}

function detectDelimiter(text){
  const firstLine = text.split(/\r?\n/)[0] || "";
  // VNA is usually ';' not ','
  if(firstLine.includes(";") && !firstLine.includes(",")) return ";";
  return ",";
}

function parseCsv(text){
  const delimiter = detectDelimiter(text);
  return new Promise((resolve, reject) => {
    Papa.parse(text, {
      header: true,
      delimiter,
      dynamicTyping: false,
      skipEmptyLines: true,
      transformHeader: (h) => mapFieldKey(h),
      complete: (results) => {
        // If there are only parsing warnings, keep going; but if data is empty, fail.
        if(results.errors && results.errors.length){
          if(!results.data || !results.data.length){
            return reject(new Error(results.errors[0].message || "CSV parsing error"));
          }
        }
        resolve(results.data);
      },
      error: (err) => reject(err)
    });
  });
}

function downloadText(filename, text){
  const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportChartPNG(chart, filename){
  const a = document.createElement("a");
  a.href = chart.toBase64Image("image/png", 1);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function exportChartLongCSV(chart, filename){
  // Long format: series,x,y (robust when x differs per series)
  const rows = [["series","x","y"]];
  for(const ds of chart.data.datasets){
    const label = ds.label ?? "series";
    const pts = Array.isArray(ds.data) ? ds.data : [];
    for(const p of pts){
      if(p && typeof p === "object" && "x" in p && "y" in p){
        rows.push([label, p.x, p.y]);
      }
    }
  }
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  downloadText(filename, csv);
}

function percentileMedian(arr){
  const a = arr.slice().sort((x,y)=>x-y);
  const n = a.length;
  if(!n) return null;
  const mid = Math.floor(n/2);
  return (n%2) ? a[mid] : (a[mid-1]+a[mid])/2;
}

function withinRange(x, min, max){
  if(min !== null && x < min) return false;
  if(max !== null && x > max) return false;
  return true;
}

function setPill(id, count){
  const el = $(id);
  el.textContent = (count === null || count === undefined) ? "—" : `${count} rows`;
}

/* =======================
   Load data (default)
   ======================= */
async function loadAll(){
  setStatus("warn", "Loading data from GitHub…");
  $("pillAstaVal").textContent = "—";
  $("pillGprVal").textContent = "—";
  $("pillVnaVal").textContent = "—";

  try{
    const [tA11, tA12, tG11, tG12, tV] = await Promise.all([
      fetchText(URLS.asta11),
      fetchText(URLS.asta12),
      fetchText(URLS.gpr11),
      fetchText(URLS.gpr12),
      fetchText(URLS.vna),
    ]);

    const [a11, a12, g11, g12, vna] = await Promise.all([
      parseCsv(tA11),
      parseCsv(tA12),
      parseCsv(tG11),
      parseCsv(tG12),
      parseCsv(tV),
    ]);

    state.raw.asta11 = a11.map(r => ({ position_m: safeNum(r.position_m), height_cm: safeNum(r.height_cm) }));
    state.raw.asta12 = a12.map(r => ({ position_m: safeNum(r.position_m), height_cm: safeNum(r.height_cm) }));
    state.raw.gpr11  = g11.map(r => ({ position_m: safeNum(r.position_m), twtt_ns: safeNum(r.twtt_ns), snow_height_m: safeNum(r.snow_height_m) }));
    state.raw.gpr12  = g12.map(r => ({ position_m: safeNum(r.position_m), twtt_ns: safeNum(r.twtt_ns), snow_height_m: safeNum(r.snow_height_m) }));

    // VNA: keep all numeric columns
    state.raw.vna = vna.map(r => {
      const out = {};
      for(const k of Object.keys(r)){
        out[k] = (k === "date_num" || k === "strumento") ? String(r[k] ?? "").trim() : safeNum(r[k]);
      }
      out.misura = safeNum(r.misura);
      out.f_hz = safeNum(r.f_hz);
      out.h_cm = safeNum(r.h_cm);
      return out;
    });

    state.loaded = true;

    setPill("pillAstaVal", state.raw.asta11.length + state.raw.asta12.length);
    setPill("pillGprVal", state.raw.gpr11.length + state.raw.gpr12.length);
    setPill("pillVnaVal", state.raw.vna.length);

    buildVNAControls();
    seedRanges();

    renderAsta();
    renderGpr();
    renderVna();

    setStatus("ok", "Data loaded.");
  } catch(err){
    console.error(err);
    setStatus("bad", `Load error: ${err.message || err}`);
  }
}

function seedRanges(){
  // ROD
  const allA = [...state.raw.asta11, ...state.raw.asta12].filter(r=>r.position_m!==null);
  const minA = Math.min(...allA.map(r=>r.position_m));
  const maxA = Math.max(...allA.map(r=>r.position_m));
  $("astaMin").value = "";
  $("astaMax").value = "";
  $("astaMin").placeholder = minA.toFixed(2);
  $("astaMax").placeholder = maxA.toFixed(2);

  // GPR
  const allG = [...state.raw.gpr11, ...state.raw.gpr12].filter(r=>r.position_m!==null);
  const minG = Math.min(...allG.map(r=>r.position_m));
  const maxG = Math.max(...allG.map(r=>r.position_m));
  $("gprMin").value = "";
  $("gprMax").value = "";
  $("gprMin").placeholder = minG.toFixed(2);
  $("gprMax").placeholder = maxG.toFixed(2);

  // VNA frequency in GHz
  const f = state.raw.vna.map(r=>r.f_hz).filter(x=>x!==null);
  const fMin = Math.min(...f)/1e9;
  const fMax = Math.max(...f)/1e9;
  $("vnaFMin").value = "";
  $("vnaFMax").value = "";
  $("vnaFMin").placeholder = fMin.toFixed(2);
  $("vnaFMax").placeholder = fMax.toFixed(2);

  const h = state.raw.vna.map(r=>r.h_cm).filter(x=>x!==null);
  const hMin = Math.min(...h);
  const hMax = Math.max(...h);
  $("vnaHMin").value = "";
  $("vnaHMax").value = "";
  $("vnaHMin").placeholder = String(hMin);
  $("vnaHMax").placeholder = String(hMax);
}

/* =======================
   Tabs
   ======================= */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    $("tab-asta").classList.toggle("hidden", tab !== "asta");
    $("tab-gpr").classList.toggle("hidden", tab !== "gpr");
    $("tab-vna").classList.toggle("hidden", tab !== "vna");

    // resize chart when switching tabs
    setTimeout(() => {
      const c = state.charts[tab];
      if(c) c.resize();
    }, 80);
  });
});

/* =======================
   Chart base options
   ======================= */
if (window.Chart && Chart.register && Array.isArray(Chart.registerables)) {
  Chart.register(...Chart.registerables);
}

function baseChartOptions(title, xLabel, yLabel){
  return {
    responsive: true,
    maintainAspectRatio: false,
    parsing: false,
    normalized: true,
    interaction: { mode: "nearest", intersect: false },
    plugins: {
      legend: { labels: { color: "#e8eefc" } },
      title: { display: false, text: title, color: "#e8eefc" },
      tooltip: {
        callbacks: {
          label: (ctx) => {
            const x = ctx.parsed.x;
            const y = ctx.parsed.y;
            return ` ${ctx.dataset.label}: x=${x}  y=${y}`;
          }
        }
      }
    },
    scales: {
      x: {
        type: "linear",
        title: { display: true, text: xLabel, color: "#a8b3d6" },
        ticks: { color: "#a8b3d6" },
        grid: { color: "rgba(255,255,255,.08)" }
      },
      y: {
        title: { display: true, text: yLabel, color: "#a8b3d6" },
        ticks: { color: "#a8b3d6" },
        grid: { color: "rgba(255,255,255,.08)" }
      }
    }
  }
}

function makeLineDataset(label, points, dashed=false){
  return {
    label,
    data: points,
    borderWidth: 2,
    pointRadius: 0,
    tension: 0.18,
    borderDash: dashed ? [6,4] : undefined,
  };
}

/* =======================
   ROD (ASTA)
   ======================= */
function getRangeInput(minId, maxId){
  const min = safeNum($(minId).value);
  const max = safeNum($(maxId).value);
  // if empty, use placeholder
  const minPH = safeNum($(minId).placeholder);
  const maxPH = safeNum($(maxId).placeholder);
  return {
    min: min !== null ? min : (minPH !== null ? minPH : null),
    max: max !== null ? max : (maxPH !== null ? maxPH : null),
  };
}

function buildAstaDatasets(lineMode, range){
  const ds = [];
  const pick = (arr, label, dashed=false) => {
    const pts = arr
      .filter(r => r.position_m !== null && r.height_cm !== null)
      .filter(r => withinRange(r.position_m, range.min, range.max))
      .map(r => ({ x: r.position_m, y: r.height_cm }));
    ds.push(makeLineDataset(label, pts, dashed));
    return pts.length;
  };

  let total = 0;
  if(lineMode === "LINE11"){
    total = pick(state.raw.asta11, "LINE11", false);
  } else if(lineMode === "LINE12"){
    total = pick(state.raw.asta12, "LINE12", false);
  } else {
    total = pick(state.raw.asta11, "LINE11", false) + pick(state.raw.asta12, "LINE12", true);
  }
  return { datasets: ds, total };
}

function renderAsta(){
  if(!state.loaded) return;
  const mode = $("astaLine").value;
  const range = getRangeInput("astaMin","astaMax");
  const { datasets, total } = buildAstaDatasets(mode, range);

  $("astaStats").textContent = `Displayed points: ${total}  |  Position range: ${range.min} – ${range.max} m`;

  const ctx = $("astaChart").getContext("2d");
  const options = baseChartOptions("Rod heights", "Position (m)", "Height (cm)");
  if(state.charts.asta){
    state.charts.asta.data.datasets = datasets;
    state.charts.asta.options = options;
    state.charts.asta.update();
  } else {
    state.charts.asta = new Chart(ctx, {
      type: "line",
      data: { datasets },
      options
    });
  }
}

/* =======================
   GPR
   ======================= */
function buildGprDatasets(lineMode, range, showTwtt, showSnow){
  const ds = [];
  const addSeries = (arr, labelPrefix, dashed=false) => {
    const base = arr
      .filter(r => r.position_m !== null)
      .filter(r => withinRange(r.position_m, range.min, range.max));

    let count = 0;

    if(showTwtt){
      const pts = base.filter(r=>r.twtt_ns!==null).map(r=>({x:r.position_m, y:r.twtt_ns}));
      ds.push({ ...makeLineDataset(`${labelPrefix} Twtt (ns)`, pts, dashed), yAxisID:"y" });
      count += pts.length;
    }
    if(showSnow){
      const pts = base.filter(r=>r.snow_height_m!==null).map(r=>({x:r.position_m, y:r.snow_height_m}));
      ds.push({ ...makeLineDataset(`${labelPrefix} Snow height (m)`, pts, dashed), yAxisID: showTwtt ? "y2" : "y" });
      count += pts.length;
    }
    return count;
  };

  let total = 0;
  if(lineMode === "LINE11"){
    total = addSeries(state.raw.gpr11, "LINE11", false);
  } else if(lineMode === "LINE12"){
    total = addSeries(state.raw.gpr12, "LINE12", false);
  } else {
    total = addSeries(state.raw.gpr11, "LINE11", false) + addSeries(state.raw.gpr12, "LINE12", true);
  }
  return { datasets: ds, total };
}

function renderGpr(){
  if(!state.loaded) return;
  const mode = $("gprLine").value;
  const range = getRangeInput("gprMin","gprMax");
  const showTwtt = $("gprShowTwtt").checked;
  const showSnow = $("gprShowSnow").checked;

  const { datasets, total } = buildGprDatasets(mode, range, showTwtt, showSnow);
  $("gprStats").textContent = `Displayed points: ${total}  |  Position range: ${range.min} – ${range.max} m`;

  const ctx = $("gprChart").getContext("2d");

  const options = baseChartOptions("GPR", "Position (m)", showTwtt && showSnow ? "Twtt / Snow height" : (showTwtt ? "Twtt (ns)" : "Snow height (m)"));
  // Decimation for large datasets
  options.plugins.decimation = { enabled: true, algorithm: "lttb", samples: 1400 };

  // If both series are shown: dual Y axis
  if(showTwtt && showSnow){
    options.scales.y = {
      type:"linear",
      position:"left",
      title:{ display:true, text:"Twtt (ns)", color:"#a8b3d6" },
      ticks:{ color:"#a8b3d6" },
      grid:{ color:"rgba(255,255,255,.08)" }
    };
    options.scales.y2 = {
      type:"linear",
      position:"right",
      title:{ display:true, text:"Snow height (m)", color:"#a8b3d6" },
      ticks:{ color:"#a8b3d6" },
      grid:{ drawOnChartArea:false, color:"rgba(255,255,255,.08)" }
    };
  } else {
    delete options.scales.y2;
  }

  if(state.charts.gpr){
    state.charts.gpr.data.datasets = datasets;
    state.charts.gpr.options = options;
    state.charts.gpr.update();
  } else {
    state.charts.gpr = new Chart(ctx, {
      type:"line",
      data:{ datasets },
      options
    });
  }
}

/* =======================
   VNA: controls and charts
   ======================= */
function buildVNAControls(){
  // Available numeric variables (exclude ids/axes)
  const sample = state.raw.vna[0] || {};
  const excluded = new Set(["date_num","strumento","misura","f_hz","h_cm"]);
  const keys = Object.keys(sample)
    .filter(k => !excluded.has(k))
    .filter(k => state.raw.vna.some(r => typeof r[k] === "number" && Number.isFinite(r[k])));

  // Fill variable select
  const sel = $("vnaVar");
  sel.innerHTML = "";
  const niceLabel = (k) => {
    const map = {
      eps_re: "eps_re",
      u_eps_re: "u_eps_re",
      eps_im: "eps_im",
      u_eps_im: "u_eps_im",
      lwc: "LWC",
      u_lwc: "u_LWC",
      density: "density",
      u_density: "u_density"
    };
    return map[k] || k;
  };
  keys.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = niceLabel(k);
    sel.appendChild(opt);
  });
  if(keys.includes("eps_re")) sel.value = "eps_re";

  // Sweep groups: (measurement, H_cm)
  const groups = new Map();
  for(const r of state.raw.vna){
    if(r.misura === null || r.h_cm === null) continue;
    const key = `M${r.misura}-H${r.h_cm}`;
    if(!groups.has(key)){
      groups.set(key, { key, misura: r.misura, h_cm: r.h_cm, label: `Measurement ${r.misura} (H ${r.h_cm} cm)` });
    }
  }
  state.vnaGroups = Array.from(groups.values()).sort((a,b)=> (a.h_cm-b.h_cm) || (a.misura-b.misura));

  const list = $("vnaGroupList");
  list.innerHTML = "";
  state.vnaGroups.forEach((g)=>{
    const lab = document.createElement("label");
    lab.className = "chk";
    const span = document.createElement("span");
    span.textContent = g.label;
    const input = document.createElement("input");
    input.type = "checkbox";
    input.checked = true;
    input.dataset.key = g.key;
    lab.appendChild(span);
    lab.appendChild(input);
    list.appendChild(lab);
  });

  updateVnaModeUI();
}

function updateVnaModeUI(){
  const mode = $("vnaMode").value;
  const sweep = mode === "SWEEP";
  $("vnaSweepGroups").classList.toggle("hidden", !sweep);
  $("vnaFreqRange").classList.toggle("hidden", !sweep);
  $("vnaHRange").classList.toggle("hidden", sweep);
  $("vnaAggRow").classList.toggle("hidden", sweep);
}

function selectedVnaGroupKeys(){
  const checks = $("vnaGroupList").querySelectorAll("input[type='checkbox']");
  const keys = [];
  checks.forEach(ch => { if(ch.checked) keys.push(ch.dataset.key); });
  return keys;
}

function vnaFreqRange(){
  const min = safeNum($("vnaFMin").value);
  const max = safeNum($("vnaFMax").value);
  const minPH = safeNum($("vnaFMin").placeholder);
  const maxPH = safeNum($("vnaFMax").placeholder);
  return {
    min: (min !== null ? min : minPH),
    max: (max !== null ? max : maxPH),
  };
}

function vnaHRange(){
  const min = safeNum($("vnaHMin").value);
  const max = safeNum($("vnaHMax").value);
  const minPH = safeNum($("vnaHMin").placeholder);
  const maxPH = safeNum($("vnaHMax").placeholder);
  return {
    min: (min !== null ? min : minPH),
    max: (max !== null ? max : maxPH),
  };
}

function renderVna(){
  if(!state.loaded) return;

  const mode = $("vnaMode").value;
  const yKey = $("vnaVar").value;

  if(mode === "SWEEP"){
    const range = vnaFreqRange();
    const keys = selectedVnaGroupKeys();
    const datasets = [];

    let total = 0;
    for(const g of state.vnaGroups){
      if(!keys.includes(g.key)) continue;

      const pts = state.raw.vna
        .filter(r => r.misura === g.misura && r.h_cm === g.h_cm)
        .filter(r => r.f_hz !== null && typeof r[yKey] === "number" && Number.isFinite(r[yKey]))
        .map(r => ({ x: r.f_hz / 1e9, y: r[yKey] }))
        .filter(p => withinRange(p.x, range.min, range.max))
        .sort((a,b)=>a.x-b.x);

      total += pts.length;
      datasets.push(makeLineDataset(g.label, pts, false));
    }

    $("vnaStats").textContent = `Displayed points: ${total}  |  Frequency range: ${range.min} – ${range.max} GHz`;

    const ctx = $("vnaChart").getContext("2d");
    const options = baseChartOptions("VNA Sweep", "f (GHz)", yKey);
    if(state.charts.vna){
      state.charts.vna.data.datasets = datasets;
      state.charts.vna.options = options;
      state.charts.vna.update();
    } else {
      state.charts.vna = new Chart(ctx, { type:"line", data:{ datasets }, options });
    }
  } else {
    // PROFILE: aggregate by H_cm
    const range = vnaHRange();
    const agg = $("vnaAgg").value;

    // Step 1: for each (measurement, h_cm), compute mean over frequencies
    const byGroup = new Map();
    for(const r of state.raw.vna){
      if(r.misura === null || r.h_cm === null) continue;
      if(r.h_cm < range.min || r.h_cm > range.max) continue;
      const y = r[yKey];
      if(typeof y !== "number" || !Number.isFinite(y)) continue;
      const k = `M${r.misura}-H${r.h_cm}`;
      if(!byGroup.has(k)) byGroup.set(k, { h_cm: r.h_cm, ys: [] });
      byGroup.get(k).ys.push(y);
    }
    const groupMeans = [];
    for(const v of byGroup.values()){
      if(!v.ys.length) continue;
      const mean = v.ys.reduce((a,b)=>a+b,0)/v.ys.length;
      groupMeans.push({ h_cm: v.h_cm, y: mean });
    }

    // Step 2: aggregate per H_cm across measurements (mean or median)
    const byH = new Map();
    for(const gm of groupMeans){
      if(!byH.has(gm.h_cm)) byH.set(gm.h_cm, []);
      byH.get(gm.h_cm).push(gm.y);
    }

    const pts = [];
    for(const [h, ys] of byH.entries()){
      const val = (agg === "MEDIAN") ? percentileMedian(ys) : (ys.reduce((a,b)=>a+b,0)/ys.length);
      pts.push({ x: Number(h), y: val });
    }
    pts.sort((a,b)=>a.x-b.x);

    $("vnaStats").textContent = `Displayed points: ${pts.length}  |  H range: ${range.min} – ${range.max} cm  |  Aggregation: ${agg.toLowerCase()}`;

    const datasets = [ makeLineDataset(`${yKey} (profile, ${agg.toLowerCase()})`, pts, false) ];
    const ctx = $("vnaChart").getContext("2d");
    const options = baseChartOptions("VNA Profile", "H (cm)", yKey);
    if(state.charts.vna){
      state.charts.vna.data.datasets = datasets;
      state.charts.vna.options = options;
      state.charts.vna.update();
    } else {
      state.charts.vna = new Chart(ctx, { type:"line", data:{ datasets }, options });
    }
  }
}

/* =======================
   Buttons / events
   ======================= */
$("btnReload").addEventListener("click", loadAll);

$("btnReset").addEventListener("click", () => {
  // Reset inputs to auto (empty), then re-seed placeholders
  ["astaMin","astaMax","gprMin","gprMax","vnaFMin","vnaFMax","vnaHMin","vnaHMax"].forEach(id => { $(id).value = ""; });

  // Reset checks
  $("gprShowTwtt").checked = true;
  $("gprShowSnow").checked = true;

  // Reset selections
  $("astaLine").value = "LINE11";
  $("gprLine").value = "LINE11";
  $("vnaMode").value = "SWEEP";
  updateVnaModeUI();

  // Select all VNA sweep series
  $("vnaGroupList").querySelectorAll("input[type='checkbox']").forEach(ch => ch.checked = true);

  seedRanges();
  renderAsta();
  renderGpr();
  renderVna();
});

$("astaApply").addEventListener("click", renderAsta);
$("gprApply").addEventListener("click", renderGpr);
$("vnaApply").addEventListener("click", renderVna);

$("vnaMode").addEventListener("change", () => {
  updateVnaModeUI();
  renderVna();
});

// Exports
$("astaPng").addEventListener("click", () => state.charts.asta && exportChartPNG(state.charts.asta, "pietrattina_rod.png"));
$("astaCsv").addEventListener("click", () => state.charts.asta && exportChartLongCSV(state.charts.asta, "pietrattina_rod.csv"));

$("gprPng").addEventListener("click", () => state.charts.gpr && exportChartPNG(state.charts.gpr, "pietrattina_gpr.png"));
$("gprCsv").addEventListener("click", () => state.charts.gpr && exportChartLongCSV(state.charts.gpr, "pietrattina_gpr.csv"));

$("vnaPng").addEventListener("click", () => state.charts.vna && exportChartPNG(state.charts.vna, "pietrattina_vna.png"));
$("vnaCsv").addEventListener("click", () => state.charts.vna && exportChartLongCSV(state.charts.vna, "pietrattina_vna.csv"));

// Auto-load on open
loadAll();
</script>
</body>
</html>
